<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Europe Health Impact Counter</title>

<style>
    body {
        font-family: Arial, sans-serif;
        text-align: center;
        background: #faf8ff;
        padding: 30px;
        color: #2E2E2E;
    }
    h1 { font-size: 32px; color: #5B3CC4; }
    p { color: #7A7A7A; }

    #counter {
        font-size: 48px;
        font-weight: bold;
        margin: 20px 0;
        color: #E2B93D;
    }
    button {
        background: #E2B93D;
        color: #2E2E2E;
        padding: 16px 36px;
        border: none;
        font-size: 20px;
        border-radius: 10px;
        cursor: pointer;
        transition: 0.2s;
    }
    button:hover { background: #f4cc4e; }

    h3 { color: #5B3CC4; }

    #progressBar {
        width: 100%;
        max-width: 500px;
        height: 14px;
        background: #E8DAFF;
        margin: 30px auto;
        border-radius: 20px;
        overflow: hidden;
    }
    #progress {
        height: 100%;
        width: 0%;
        background: #5B3CC4;
        transition: width 0.6s ease;
    }

    .dot {
        fill: #E2B93D;
        animation: pop 0.3s ease-out, glow 0.8s ease-out;
    }
    @keyframes pop {
        0% { r: 0; opacity: 0; }
        100% { r: 3; opacity: 1; }
    }
    @keyframes glow {
        0% { filter: drop-shadow(0 0 0px #E2B93D); }
        100% { filter: drop-shadow(0 0 6px #E2B93D); }
    }
</style>
</head>

<body>

<h1>Europe’s Health Impact</h1>
<p>Each tap represents €1 of potential EU investment in global health.</p>

<div id="counter">0</div>

<button id="supportBtn">SUPPORT</button>

<h3>Potential Investment: <span id="euros">€0</span></h3>
<h3>Lives Saved: <span id="lives">0</span></h3>

<!-- Simplified Brussels Map -->
<div style="margin-top:30px;">
    <svg id="brusselsMap" width="260" height="260" viewBox="0 0 200 200">
        <path id="mapFill"
            d="M110 15 L155 30 L178 60 L190 100 L183 140 L162 170 L132 188 
               L95 190 L62 176 L38 145 L27 110 L32 75 L52 45 L82 25 Z"
            fill="rgba(226,185,61,0.25)"
            stroke="#5B3CC4"
            stroke-width="3" />
    </svg>
</div>

<div id="progressBar"><div id="progress"></div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getDatabase,
  ref,
  onValue,
  runTransaction,
  push,
  onChildAdded
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

// Your Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAXlmtIAJgPvqVvViIQZlhhsx4XhfkE_xQ",
  authDomain: "eu-impact-counter.firebaseapp.com",
  databaseURL: "https://eu-impact-counter-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "eu-impact-counter",
  storageBucket: "eu-impact-counter.firebasestorage.app",
  messagingSenderId: "585888162252",
  appId: "1:585888162252:web:c13c683de5d8ac1e743d69"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const votesRef = ref(db, "votes");
const pointsRef = ref(db, "points");

// Limit 1 vote per browser
if (localStorage.getItem("voted")) {
  document.getElementById("supportBtn").disabled = true;
  document.getElementById("supportBtn").innerText = "THANK YOU ❤️";
}

// Load votes live
onValue(votesRef, snapshot => {
  const votes = snapshot.val() || 0;
  updateUI(votes);
});

// Load points live
onChildAdded(pointsRef, snapshot => {
  const point = snapshot.val();
  drawPoint(point.x, point.y);
});

// Vote click
document.getElementById("supportBtn").onclick = () => {
  if (localStorage.getItem("voted")) return;

  localStorage.setItem("voted", "yes");
  document.getElementById("supportBtn").disabled = true;
  document.getElementById("supportBtn").innerText = "THANK YOU ❤️";

  runTransaction(votesRef, v => (v || 0) + 1);

  const p = randomPointInsidePolygon(brusselsPolygon);
  push(pointsRef, p);
};

// UI update
function updateUI(votes) {
  document.getElementById("counter").innerText = votes;
  document.getElementById("euros").innerText = "€" + votes.toLocaleString();
  document.getElementById("lives").innerText = Math.round(votes * 1.5).toLocaleString();
  const percent = Math.min(votes / 800000000 * 100, 100);
  document.getElementById("progress").style.width = percent + "%";
}

// Draw a new glowing dot
function drawPoint(x, y) {
  const svg = document.getElementById("brusselsMap");
  const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
  dot.setAttribute("cx", x);
  dot.setAttribute("cy", y);
  dot.setAttribute("r", 3);
  dot.setAttribute("class", "dot");
  svg.appendChild(dot);
}

// Polygon for point-in-polygon
const brusselsPolygon = [
  [110, 15], [155, 30], [178, 60], [190, 100], [183, 140],
  [162, 170], [132, 188], [95, 190], [62, 176], [38, 145],
  [27, 110], [32, 75], [52, 45], [82, 25]
];

// Point in polygon
function isInsidePoly(x, y, poly) {
  let inside = false;
  for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) {
    const xi = poly[i][0], yi = poly[i][1];
    const xj = poly[j][0], yj = poly[j][1];
    const intersect = (yi > y !== yj > y) && 
      x < (xj - xi) * (y - yi) / ((yj - yi) + 0.00001) + xi;
    if (intersect) inside = !inside;
  }
  return inside;
}

// Generate random point inside polygon
function randomPointInsidePolygon(poly) {
  let minX = Math.min(...poly.map(p => p[0]));
  let maxX = Math.max(...poly.map(p => p[0]));
  let minY = Math.min(...poly.map(p => p[1]));
  let maxY = Math.max(...poly.map(p => p[1]));

  for (let i = 0; i < 80; i++) {
    const x = minX + Math.random() * (maxX - minX);
    const y = minY + Math.random() * (maxY - minY);
    if (isInsidePoly(x, y, poly)) return { x, y };
  }
  return { x: 110, y: 110 };
}
</script>

</body>
</html>
